@model IEnumerable<projekt_zespolowy.Models.Budget>
@using projekt_zespolowy.Models

@{
    ViewData["Title"] = "Pulpit";
    var balance = (decimal)ViewData["MainBalance"];
    var transactions = ViewData["RecentTransactions"] as List<Transaction>;
    var budgets = ViewData["Budgets"] as List<Budget>;
    var upcomingPayments = ViewBag.UpcomingPayments as List<PaymentEvent>;
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Witaj, <span class="text-primary">@User.Identity.Name</span>! 👋</h2>
        <div class="text-muted small">
            @DateTime.Now.ToString("dd MMMM yyyy, dddd")
        </div>
    </div>

    @if (upcomingPayments != null && upcomingPayments.Any())
    {
        <div class="alert alert-warning payment-alert shadow-sm border-start border-warning border-4 mb-4" role="alert">
            <h5 class="alert-heading d-flex align-items-center fw-bold">
                <i class="fas fa-exclamation-triangle me-2"></i> Nadchodzące płatności
            </h5>
            <hr>
            <div class="list-group list-group-flush bg-transparent">
                @foreach (var payment in upcomingPayments)
                {
                    var daysLeft = (payment.Date.Date - DateTime.Today).Days;
                    string badgeClass = daysLeft < 0 ? "bg-danger" : (daysLeft == 0 ? "bg-danger" : "bg-warning text-dark");
                    string daysText = daysLeft < 0 ? $"{Math.Abs(daysLeft)} dni po terminie!" : (daysLeft == 0 ? "DZISIAJ" : $"za {daysLeft} dni");

                    <div class="payment-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>@payment.Title</strong>
                            <span class="badge @badgeClass ms-2">@daysText</span>
                            <div class="small opacity-75">
                                @payment.Date.ToShortDateString() &bull; <strong>@payment.Amount.ToString("C")</strong>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-success confirm-payment-btn shadow-sm" data-id="@payment.Id">
                            <i class="fas fa-check me-1"></i> Zapłać
                        </button>
                    </div>
                }
            </div>
        </div>
    }

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-chart-bar me-2 text-secondary"></i>Przepływ Gotówki (30 dni)</span>
                </div>
                <div class="card-body">
                    <div style="height: 350px; width: 100%;">
                        <canvas id="dashboardChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="far fa-calendar-check me-2 text-secondary"></i>Nadchodzące</span>
                    <a asp-controller="Calendar" asp-action="Index" class="btn btn-sm btn-outline-primary" style="font-size: 0.75rem;">
                        Pełny &rarr;
                    </a>
                </div>
                <div class="card-body p-2">
                    <div id="miniCalendar" style="font-size: 0.85rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card text-center bg-light shadow-sm mb-4 border-start border-5 @(balance >= 0 ? "border-success" : "border-danger")">
        <div class="card-body py-4">
            <h5 class="card-title text-muted text-uppercase small ls-1">Dostępne Środki</h5>
            <h1 class="display-4 fw-bold mb-0 @(balance >= 0 ? "text-success" : "text-danger")">
                @balance.ToString("N2") <small class="fs-4 text-muted">PLN</small>
            </h1>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-bottom">
                    <i class="fas fa-piggy-bank me-2 text-secondary"></i>Twoje Budżety
                </div>
                <div class="list-group list-group-flush">
                    @if (budgets != null && budgets.Any())
                    {
                        foreach (var b in budgets)
                        {
                            <div class="list-group-item bg-transparent">
                                <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                    <h6 class="mb-0 fw-bold">@b.Category.Name</h6>
                                    <span class="badge rounded-pill bg-light text-dark border">@b.Priority</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="small text-muted">Limit: <strong>@b.Amount.ToString("N0") PLN</strong></span>
                                    <a asp-controller="Budgets" asp-action="Edit" asp-route-id="@b.Id" class="text-decoration-none small text-primary">Edytuj</a>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-search-dollar fa-2x mb-2 d-block opacity-25"></i>
                            Brak budżetów na ten miesiąc.
                        </div>
                    }
                </div>
                <div class="card-footer bg-white text-center border-top-0">
                    <a asp-controller="Budgets" asp-action="Create" class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-plus me-1"></i> Dodaj Budżet
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white fw-bold border-bottom">
                    <i class="fas fa-history me-2 text-secondary"></i>Ostatnie Operacje
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <tbody>
                            @if (transactions != null && transactions.Any())
                            {
                                foreach (var t in transactions)
                                {
                                    bool isFuture = t.Date > DateTime.Now;
                                    <tr class="@(isFuture ? "table-warning" : "")">
                                        <td class="ps-3">
                                            <div class="fw-bold text-truncate" style="max-width: 150px;">
                                                @if (t.Type == TransactionType.Income)
                                                {
                                                    <i class="fas fa-arrow-up text-success me-1 small"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-arrow-down text-danger me-1 small"></i>
                                                }
                                                @(string.IsNullOrEmpty(t.Description) ? "Bez opisu" : t.Description)
                                            </div>
                                            <div class="small text-muted">
                                                @t.Date.ToString("dd.MM")
                                                @if (isFuture)
                                                {
                                                    <span class="badge bg-warning text-dark ms-1" style="font-size: 0.6rem;">PLAN</span>
                                                }
                                            </div>
                                        </td>
                                        <td class="text-end pe-3">
                                            <span class="@(t.Type == TransactionType.Income ? "text-success" : "text-danger") fw-bold">
                                                @(t.Type == TransactionType.Income ? "+" : "-")@t.Amount.ToString("N2")
                                            </span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="2" class="p-4 text-center text-muted">
                                        <i class="fas fa-receipt fa-2x mb-2 d-block opacity-25"></i>
                                        Brak ostatnich transakcji.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer bg-white text-center border-top-0">
                    <a asp-controller="Transactions" asp-action="Create" class="btn btn-sm btn-outline-success w-100">
                        <i class="fas fa-plus me-1"></i> Nowa Transakcja
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const rawData = @Html.Raw(ViewData["ChartData"] ?? "[]");
            if (rawData.length > 0) {
                const ctx = document.getElementById('dashboardChart').getContext('2d');
                const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: rawData.map(x => x.Date),
                        datasets: [
                            { label: 'Przychody', data: rawData.map(x => x.Income), backgroundColor: '#1cc88a' },
                            { label: 'Wydatki', data: rawData.map(x => x.Expense), backgroundColor: '#e74a3b' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            var miniCalendarEl = document.getElementById('miniCalendar');
            var miniCalendar = new FullCalendar.Calendar(miniCalendarEl, {
                initialView: 'listMonth',
                locale: 'pl',
                height: 350,
                headerToolbar: {
                    left: '',
                    center: 'title',
                    right: ''
                },
                events: '/Calendar/GetEvents',
                eventClick: function (info) {
                    window.location.href = '/Calendar/Index';
                },
                noEventsText: 'Brak płatności',

                eventContent: function (arg) {
                    let isPaid = arg.event.extendedProps.isPaid;
                    let amount = arg.event.extendedProps.amount;

                    let statusIcon = isPaid
                        ? '<span class="badge bg-success me-2"><i class="fas fa-check"></i></span>'
                        : '<span class="badge bg-warning text-dark me-2"><i class="fas fa-clock"></i></span>';

                    let htmlContent = `
                                <div class="fc-list-event-title d-flex align-items-center justify-content-between w-100">
                                    <div>
                                        ${statusIcon}
                                        <span>${arg.event.title}</span>
                                    </div>
                                </div>
                            `;

                    return { html: htmlContent };
                }
            });
            miniCalendar.render();

            document.querySelectorAll('.confirm-payment-btn').forEach(button => {
                button.addEventListener('click', function () {
                    if (!confirm("Czy na pewno chcesz potwierdzić opłacenie tej subskrypcji? Zostanie dodany wydatek, a termin przesunie się na kolejny okres.")) return;

                    var id = this.getAttribute('data-id');
                    var btn = this;

                    fetch('/Calendar/ConfirmPayment?id=' + id, {
                        method: 'POST',
                        headers: {
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                location.reload();
                            } else {
                                alert("Wystąpił błąd podczas potwierdzania płatności.");
                            }
                        });
                });
            });

        });
    </script>
}